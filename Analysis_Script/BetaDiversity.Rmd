---
title: "BetaDiversity"
output: html_document
---

Load in taxonomy phyloseq object, run beta diversity, plot results, and run statistics.

```{r Load data and libraries}
library(tidyverse)
library(phyloseq)
library(vegan)

# Load object
ps = readRDS('../datasets_and_results/phyloseq_taxonomy.rds')

# rarefy the data:
psrare = ps %>% rarefy_even_depth(sample.size = 500, rngseed = 420)
```

```{r calculate bray-curtis distances}
set.seed(420)
# Calculate the distance between each sample pair
ps_bray = phyloseq::distance(psrare, method = "wunifrac")
View(as.matrix(ps_bray)) # Every pairwise comparison included
```

Apply multidimensional scaling (MDS). This takes the distance matrix and reduces it to a few dimensions.

```{r normalize and plot}
set.seed(420)
# MDS scaling
mds = metaMDS(ps_bray)

# Extract data
mds_data = mds$points %>% as.data.frame %>%
  merge(sample_data(psrare), by='row.names', sort=F)
head(mds_data)

# Plot it
p = mds_data %>%
  ggplot(aes(MDS1,MDS2,color = p_order)) +
  geom_point() +
  stat_ellipse() +
  theme_classic(base_size=18)
p
```

Run PERMANOVAs using the adonis() function from the vegan package.

```{r PERMANOVA on p_order}
set.seed(420)
metadata = sample_data(psrare) %>% data.frame() # to make the next lines easier

# Single variable
stats_univar = adonis2(ps_bray ~ p_order, data = metadata)

# Two variables - adding Diet as a covariable
# by='margin' is important here - it gives the stats for each variable separately
stats_multivar = adonis2(ps_bray ~ p_order + Diet, data = metadata, by = 'margin') 

# Combine into a table
stats = bind_rows('Univariate' = stats_univar %>% as.data.frame() %>% 
                    rownames_to_column('Variable'),
                  'Multivariate' = stats_multivar %>% as.data.frame() %>% 
                    rownames_to_column('Variable'),
                  .id = 'Model') # First column is Model, either Uni or Multi

# Add some formattings
stats = stats %>% rename(Pval = `Pr(>F)`) %>%
  filter(!is.na(Pval)) # Remove the irrelevant lines

stats 
```

Subset the distance matrix object, then compare specific groups that are shown in the beta diversity plot

Comparing Perciformes and Labriformes
```{r - subset distance matrix}
set.seed(420)
# Select two orders to compare
to_compare_PL = c('Perciformes','Labriformes')
# Labriformes Centrarchiformes Blenniiformes

# List samples that belong to those orders
samples_to_keep_PL = metadata %>% filter(p_order %in% to_compare_PL) %>% rownames()

# Subset the distance matrix to only include those samples
ps_bray_sub_PL = as.matrix(ps_bray)[samples_to_keep_PL,samples_to_keep_PL] %>% as.dist()

# Run a PERMANOVA on just those two orders
stats_univar_PL = adonis2(ps_bray_sub_PL ~ p_order,
                       data = metadata %>% filter(p_order %in% to_compare_PL))

stats_univar_PL
```

Comparing Perciformes and Centrarchiformes
```{r - subset distance matrix}
set.seed(420)
# Select two orders to compare
to_compare_PC = c('Perciformes','Centrarchiformes')
# Labriformes Centrarchiformes Blenniiformes

# List samples that belong to those orders
samples_to_keep_PC = metadata %>% filter(p_order %in% to_compare_PC) %>% rownames()

# Subset the distance matrix to only include those samples
ps_bray_sub_PC = as.matrix(ps_bray)[samples_to_keep_PC,samples_to_keep_PC] %>% as.dist()

# Run a PERMANOVA on just those two orders
stats_univar_PC = adonis2(ps_bray_sub_PC ~ p_order,
                       data = metadata %>% filter(p_order %in% to_compare_PC))

stats_univar_PC
```

Comparing Perciformes and Blenniiformes
```{r - subset distance matrix}
set.seed(420)
# Select two orders to compare
to_compare_PB = c('Perciformes','Blenniiformes')
# Labriformes Centrarchiformes Blenniiformes

# List samples that belong to those orders
samples_to_keep_PB = metadata %>% filter(p_order %in% to_compare_PB) %>% rownames()

# Subset the distance matrix to only include those samples
ps_bray_sub_PB = as.matrix(ps_bray)[samples_to_keep_PB,samples_to_keep_PB] %>% as.dist()

# Run a PERMANOVA on just those two orders
stats_univar_PB = adonis2(ps_bray_sub_PB ~ p_order,
                       data = metadata %>% filter(p_order %in% to_compare_PB))

stats_univar_PB
```



```{r save outputs}
# Save plot
ggsave('../Results - Beta Diversity.jpeg',
       plot = p,
       height= 4, width = 6)

# Save statistics as an Excel file
writexl::write_xlsx(list('Beta Diversity' = stats),
                    '../Results - Beta Diversity.xlsx')
```
