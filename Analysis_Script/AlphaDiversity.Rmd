---
title: "AlphaDiversity"
output: html_document
---

```{r Load data and libraries}
library(tidyverse)
library(phyloseq)
library(vegan)

# Load object
ps = readRDS('../datasets_and_results/phyloseq_taxonomy.rds')
```

Rarefy phyloseq object.

```{r rarefaction}
hist(sample_sums(ps))

# Alpha rarefaction curve (takes a VERY long time to run with large datasets):
rarecurve( t( data.frame( ps@otu_table)),
          step=1000) # Only test in 1000 increments

# Once you've decided on a depth, you can then rarefy the data:
psrare = ps %>% rarefy_even_depth(sample.size = 500, rngseed = 420)

table(sample_sums(psrare))
unique(sample_data(psrare)$p_order)
table(sample_data(psrare)$p_order)
```

Calculate alpha diversity.

```{r calculate and plot alpha diversity}
# Pull the data from the plot:
pdata = p$data

str(pdata) # variable denotes metric, value denotes value

# Let's plot this again:
p_formatted = pdata %>% ggplot(aes(p_order,value,fill = p_order)) +
  
  # Don't plot outlier points
  geom_boxplot(outlier.shape = NA) + 
  
  # Space the points out sideways, reducing overlap.
  geom_jitter(height=0,width=0.2) +
  
  # Add some formatting
  theme_classic(base_size=18) +
  facet_wrap(~variable,ncol=4,scales = 'free_y') +
  ylab('Alpha Diversity') + xlab(NULL) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) +
  labs(fill='Order')
p_formatted


```

It's looking good! Now we need to know which groups are different from each other.

If we just need basic statistics and don't need to worry about saving pour results, we could add them directly to the plot:

```{r stats on plot}
# install.packages("ggpubr")
library(ggpubr) # Publication-ready ggplot2

comparisons = list( c('Perciformes','Centrarchiformes'), 
                    c('Perciformes','Blenniiformes'),
                    c('Perciformes','Labriformes'))

p_formatted +
  stat_compare_means(comparisons = comparisons, method='kruskal.test', size=6)

p_formatted +
  stat_compare_means(comparisons = comparisons, method='kruskal.test', size=6) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) # c(bottom, top)
```

```{r manual stats}
# Running all Kruskal Wallis tests ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
comparisons = list( c('Perciformes','Centrarchiformes'), 
                    c('Perciformes','Blenniiformes'),
                    c('Perciformes','Labriformes'))

stats = pdata %>% group_by(variable) %>% # Running each metric concurrently
  group_modify(~ {
    
    temp_stats = data.frame() 
    
    for(i in comparisons){
      # i = comparisons[[1]]
      # Filter dataset
      temp = .x %>% filter(p_order %in% i) #.x is the grouped dataset
      # Run test
      wtest = kruskal.test(formula = value ~ p_order,
                          data = temp) %>%
        broom::tidy() %>% 
        mutate(group1 = i[1], group2 = i[2],
               .before = 'statistic')
      # Add to temp_stats
      temp_stats = bind_rows(temp_stats,wtest)
    }
    
    # Add adjusted p values
    temp_stats = temp_stats %>% 
      mutate(padj = p.adjust(p.value, method='BH'), .after='p.value')
    
    return(temp_stats)
    }
  ) %>% 
  ungroup()

View(stats)
```

You have two options for adding the stats. The first is to add them manually in Powerpoint or a similar program. This is perfectly acceptable, but also a pain.

If it's preferable to add them programmatically, we can do that too. The downside is that it won't add any horizontal bars, so those have to be added separately if desired.

```{r add them to the plot}
# calculate maximum diversity values - for plotting
maxvals = pdata %>% group_by(variable) %>% 
  summarize(max.y = max(value)) %>% ungroup()

# Create a table that describes which p value goes where
annot = stats %>% 
  rename(p_order = group2) %>% # To match the plot data
  mutate(label = paste('Padj=',signif(padj,digits = 2),sep='')) %>% # Keep Padj to 2 sig figs
  left_join(maxvals) %>% 
  mutate(ypos = 1.1*max.y) # Place P values just a little above the highest point

# Add to plot
p_formatted +
  geom_text(data = annot, aes(label = label, y = ypos), size=5) +
  scale_y_continuous(expand = expansion(mult = c(0,0.1)))

# Change the P values to asterisks.
annot = annot %>% 
  mutate(label2 = ifelse(padj>0.05,'NS',
                         ifelse(padj>0.01,'*',
                                ifelse(padj>0.001,'**', '***'))))

# Add to plot
p_final = p_formatted +
  geom_text(data = annot, aes(label = label2, y = ypos), size=5) +
  scale_y_continuous(expand = expansion(mult = c(0,0.1)))
p_final
```

```{r save outputs}
# Save plot
ggsave('../Results - Alpha Diversity.jpeg',
       plot = p_final,
       height= 4, width = 12)

# Save statistics as an Excel file
writexl::write_xlsx(list('Alpha Diversity' = stats),
                    '../Results - Alpha Diversity.xlsx')
```
